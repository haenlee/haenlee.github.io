---
title: "[DB] Transaction"
excerpt: "" 

categories:
  - DB
tags:
  - [DB]

toc: true
toc_sticky: true
 
date: 2022-10-25
last_modified_at: 2022-10-25
---

# ğŸš€ Transaction
---
## ğŸ“ Transaction ì´ë€
- DBë¥¼ ì¡°ì‘í•˜ëŠ” ì‘ì—…ì˜ ë‹¨ìœ„(unit of work)
- DBì—ì„œ ë…¼ë¦¬ì ì¸ ì‘ì—…ì˜ ë‹¨ìœ„ì´ë©°, ì¥ì• ê°€ ë°œìƒí–ˆì„ ë•Œ ë°ì´í„°ë¥¼ ë³µêµ¬í•˜ëŠ” ì‘ì—…ì˜ ë‹¨ìœ„ë¼ê³  í•  ìˆ˜ ìˆë‹¤.

## ğŸ“ ACID
ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” íŠ¸ëœì­ì…˜ ì†ì„±, ë¬´ê²°ì„±ê³¼ ì¼ê´€ì„±ì„ ë³´ì¥
- ì›ìì„±(Atomicity)
    - íŠ¸ëœì­ì…˜ê³¼ ê´€ë ¨ëœ ì‘ì—…ë“¤ì´ ë¶€ë¶„ì ìœ¼ë¡œ ì‹¤í–‰ë˜ë‹¤ê°€ ì¤‘ë‹¨ë˜ì§€ ì•ŠëŠ” ê²ƒì„ ë³´ì¥
    - ì†¡ê¸ˆí•˜ëŠ” ì‚¬ëŒì˜ ê³„ì¢Œì—ì„œ ëˆì€ ë¹ ì ¸ë‚˜ê°”ëŠ”ë° ë°›ëŠ” ì‚¬ëŒì˜ ê³„ì¢Œì— ëˆì´ ë“¤ì–´ì˜¤ì§€ ì•ŠëŠ” ì¼ì€ ì—†ì–´ì•¼ í•œë‹¤.
- ì¼ê´€ì„±(Consistency)
    - íŠ¸ëœì­ì…˜ì´ ì‹¤í–‰ì„ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œí•˜ë©´ ì–¸ì œë‚˜ ì¼ê´€ì„± ìˆëŠ” ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœë¡œ ìœ ì§€í•˜ëŠ” ê²ƒì„ ì˜ë¯¸
    - ì†¡ê¸ˆí•˜ëŠ” ì‚¬ëŒì˜ ê³„ì¢Œ ì”ê³ ê°€ 0ë³´ë‹¤ ì‘ì•„ì§€ë©´ ì•ˆ ëœë‹¤.
- ê²©ë¦¬ì„±(Isolation)
    - íŠ¸ëœì­ì…˜ì„ ìˆ˜í–‰ ì‹œ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì˜ ì—°ì‚° ì‘ì—…ì´ ë¼ì–´ë“¤ì§€ ëª»í•˜ë„ë¡ ë³´ì¥í•˜ëŠ” ê²ƒì„ ì˜ë¯¸
    - ì†¡ê¸ˆí•˜ëŠ” ì‚¬ëŒì˜ ê³„ì¢Œì—ì„œ ëˆì€ ë¹ ì ¸ë‚˜ê°”ëŠ”ë° ë°›ëŠ” ì‚¬ëŒì˜ ê³„ì¢Œì— ëˆì´ ì•„ì§ ë“¤ì–´ê°€ì§€ ì•Šì€ DB ìƒí™©ì„ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ì½ìœ¼ë©´ ì•ˆ ëœë‹¤.
- ì§€ì†ì„±(Durability)
    - í•œ ë²ˆ ì €ì¥ëœ íŠ¸ëœì­ì…˜ì„ ì˜êµ¬íˆ ë³´ì¡´
    - í•œ ë²ˆ ì†¡ê¸ˆì´ ì„±ê³µí•˜ë©´ ì€í–‰ ì‹œìŠ¤í…œì— ì¥ì• ê°€ ë°œìƒí•˜ë”ë¼ë„ ì†¡ê¸ˆì´ ì„±ê³µí•œ ìƒíƒœë¡œ ë³µêµ¬í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.

## ğŸ“ Isolation Level
ì‹¤ì œë¡œëŠ” ACID ì›ì¹™ì€ ì¢…ì¢… ì§€ì¼œì§€ì§€ ì•ŠëŠ”ë‹¤.
ì™œëƒí•˜ë©´ ACID ì›ì¹™ì„ strict í•˜ê²Œ ì§€í‚¤ë ¤ë©´ ë™ì‹œì„±ì´ ë§¤ìš° ë–¨ì–´ì§€ê¸° ë•Œë¬¸ì´ë‹¤.  
â†’ DB ì—”ì§„ì€ ACID ì›ì¹™ì„ í¬ìƒí•˜ì—¬ ë™ì‹œì„±ì„ ì–»ì„ ìˆ˜ ìˆëŠ” ë°©ë²•ì„ ì œê³µ (= Isolation Level)

- ANSI/ISO SQL standard ì—ì„œ ì •ì˜í•œ Isolation level
    - READ UNCOMMITTED
        - ì»¤ë°‹ë˜ì§€ ì•Šì€ ê²ƒì„ ì½ëŠ”ë‹¤.
        - ë™ì‹œì„±ì´ ë†’ì•„ ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ê°™ì€ ë°ì´í„°ë¥¼ ì½ê³  ìˆ˜ì •í•  ìˆ˜ ìˆê²Œ ë˜ëŠ” ë°˜ë©´ ë°ì´í„° ìì²´ê°€ ì˜ëª»ë  ìˆ˜ ìˆì–´ ì¼ê´€ì„±ì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆë‹¤.
    - READ COMMITTED
        - ì»¤ë°‹ëœ ê²ƒì„ ì½ëŠ”ë‹¤.
    - REPEATABLE READ
        - ë°˜ë³µì ìœ¼ë¡œ ì½ëŠ”ë‹¤.
    - SERIALIZABLE
        - ì§ë ¬í™”ê°€ ê°€ëŠ¥í•˜ë‹¤.
        - ì§ë ¬í™”ê°€ ê°€ëŠ¥í•˜ë‹¨ ëœ»ì²˜ëŸ¼ í…Œì´ë¸” ë°ì´í„°ì— ì—¬ëŸ¬ íŠ¸ëœì­ì…˜ì´ ì¤„ì„œì„œ ê¸°ë‹¤ë¦¬ë“¯ ì²˜ë¦¬ ë˜ê²Œ ëœë‹¤.
        ì¦‰, í•œ íŠ¸ëœì­ì…˜ë§Œ ì½ê³  ìˆ˜ì •í•  ìˆ˜ ìˆê²Œ ë˜ë¯€ë¡œ ì¼ê´€ì„±ì€ ê·¹ë„ë¡œ ë†’ì•„ì§€ì§€ë§Œ, ë™ì‹œì„±ì€ í˜„ì €íˆ ë–¨ì–´ì§€ê²Œ ëœë‹¤.

- DB ì—”ì§„ì€ isolation levelì— ë”°ë¼ ì„œë¡œ ë‹¤ë¥¸ locking ì „ëµì„ ì·¨í•œë‹¤.  
  isolation levelì´ ë†’ì•„ì§ˆìˆ˜ë¡ ë” ë§ì´, ë” ë¹¡ë¹¡í•˜ê²Œ lockì„ ê±°ëŠ” ê²ƒì´ë‹¤.  
  â†’ ê°ê°ì˜ isolation levelì„ ì–¸ì œ ì‚¬ìš©í•´ì•¼ í•˜ëŠ”ì§€, í˜¹ì€ ê° isolation levelì˜ ìœ„í—˜ì„±ì€ ë¬´ì—‡ì¸ì§€ ì•Œê¸° ìœ„í•´ì„œëŠ” ê° isolation level ë³„ locking ì „ëµì„ íŒŒì•…í•´ì•¼ í•œë‹¤.

## ğŸ“ MySql InnoDBì˜ lock
InnoDBëŠ” transactionì˜ ACID ì›ì¹™ê³¼ ë™ì‹œì„±ì„ ìµœëŒ€í•œ ë³´ì¥í•˜ê¸° ìœ„í•´ ë‹¤ì–‘í•œ ì¢…ë¥˜ì˜ lockì„ ì‚¬ìš©í•œë‹¤.

### Row-level lock
í…Œì´ë¸”ì˜ rowë§ˆë‹¤ ê±¸ë¦¬ëŠ” row-level lock
- Shared lock(S lock)
    - readì— ëŒ€í•œ lock
    - ì¼ë°˜ì ì¸ SELECT ì¿¼ë¦¬ëŠ” lockì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  DBë¥¼ ì½ì–´ ë“¤ì¸ë‹¤.
    í•˜ì§€ë§Œ `SELECT ... FOR SHARE` ë“± ì¼ë¶€ SELECT ì¿¼ë¦¬ëŠ” read ì‘ì—…ì„ ìˆ˜í–‰í•  ë•Œ InnoDBê°€ ê° rowì— S lockì„ ê±´ë‹¤.
- Exclusive lock(X lock)
    - writeì— ëŒ€í•œ lock
    - `SELECT ... FOR UPDATE`ë‚˜ `UPDATE, DELETE ë“±`ì˜ ìˆ˜ì • ì¿¼ë¦¬ë¥¼ ë‚ ë¦´ ë•Œ InnoDBê°€ ê° rowì— X lockì„ ê±´ë‹¤.
- S lockê³¼ X lockì„ ê±°ëŠ” ê·œì¹™
    - ì—¬ëŸ¬ transactionì´ ë™ì‹œì— í•œ rowì— S lockì„ ê±¸ ìˆ˜ ìˆë‹¤.
    ì¦‰, ì—¬ëŸ¬ transactionì´ ë™ì‹œì— í•œ rowë¥¼ ì½ì„ ìˆ˜ ìˆë‹¤.
    - S lockì´ ê±¸ë ¤ìˆëŠ” rowì— ë‹¤ë¥¸ transactionì´ X lockì„ ê±¸ ìˆ˜ ì—†ë‹¤.
    ì¦‰, ë‹¤ë¥¸ transactionì´ ì½ê³  ìˆëŠ” rowë¥¼ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•  ìˆ˜ ì—†ë‹¤.
    - X lockì´ ê±¸ë ¤ìˆëŠ” rowì—ëŠ” ë‹¤ë¥¸ transactionì´ S lockê³¼ X lock ë‘˜ ë‹¤ ê±¸ ìˆ˜ ì—†ë‹¤.
    ì¦‰, ë‹¤ë¥¸ transactionì´ ìˆ˜ì •í•˜ê±°ë‚˜ ì‚­ì œí•˜ê³  ìˆëŠ” rowëŠ” ì½ê¸°, ìˆ˜ì •, ì‚­ì œê°€ ì „ë¶€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.
    
    â†’ ìš”ì•½í•˜ìë©´, S lockì„ ì‚¬ìš©í•˜ëŠ” ì¿¼ë¦¬ë¼ë¦¬ëŠ” ê°™ì€ rowì— ì ‘ê·¼ ê°€ëŠ¥í•˜ë‹¤.  
    ã€€ë°˜ë©´, X lockì´ ê±¸ë¦° rowëŠ” ë‹¤ë¥¸ ì–´ë– í•œ ì¿¼ë¦¬ë„ ì ‘ê·¼ ë¶ˆê°€ëŠ¥í•˜ë‹¤.  
    ã€€â€œSharedâ€ì™€ â€œexclusiveâ€ë¼ëŠ” ì´ë¦„ì˜ ì˜ë¯¸ì™€ ì •í™•íˆ ì¼ì¹˜í•œë‹¤.
    
### Record lock
DBì˜ index recordì— ê±¸ë¦¬ëŠ” lock
- S lock
- X lock (INSERT, UPDATE, DELETE)

### Gap lock
DB index recordì˜ gapì— ê±¸ë¦¬ëŠ” lock
gapì´ë€ index ì¤‘ DBì— ì‹¤ì œ recordê°€ ì—†ëŠ” ë¶€ë¶„ì´ë‹¤.

- gap lockì€ í•´ë‹¹ gapì— ì ‘ê·¼í•˜ë ¤ëŠ” ë‹¤ë¥¸ ì¿¼ë¦¬ì˜ ì ‘ê·¼ì„ ë§‰ëŠ”ë‹¤.
- Record lockì´ í•´ë‹¹ indexë¥¼ íƒ€ë ¤ëŠ” ë‹¤ë¥¸ ì¿¼ë¦¬ì˜ ì ‘ê·¼ì„ ë§‰ëŠ” ê²ƒê³¼ ë™ì¼í•˜ë‹¤.
ë‘˜ì˜ ì°¨ì´ì ì´ë¼ë©´ record lockì´ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” rowê°€ ë³€ê²½ë˜ì§€ ì•Šë„ë¡ ë³´í˜¸í•˜ëŠ” ë°˜ë©´, gap lockì€ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ìƒˆë¡œìš´ rowê°€ ì¶”ê°€ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê¸° ìœ„í•¨ì´ë‹¤.
- Gapì€ í•œ index ê°’ì¼ ìˆ˜ë„, ì—¬ëŸ¬ index ê°’ì¼ ìˆ˜ë„, í˜¹ì€ ì•„ì˜ˆ ì•„ë¬´ ê°’ë„ ì—†ì„ ìˆ˜ë„ ìˆë‹¤.
- (INSERT, UPDATE, DELETE)

### Next-Key Lock
ë²”ìœ„ë¥¼ ì§€ì •í•œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í•  ë•Œ, Record lockê³¼ Gap lockì´ ë³µí•©ì ìœ¼ë¡œ ê±¸ë¦¬ëŠ” lock  
â†’ ë”°ë¼ì„œ `autoincrement`ì“°ë©´ ì•ˆë¨

ë‹¤ìŒ ê³µê°„ì„ ë§‰ëŠ”ë‹¤ëŠ” ê±´ë°, ë‹¤ìŒ í‚¤ê°€ ì—†ì–´ì„œ ì „ì²´ ê³µê°„ì„ ë§‰ê²Œ ë˜ëŠ” í˜„ìƒì´ ìƒê¸´ë‹¤.  
ë³‘ëª©ì´ ìƒê¸´ë‹¤.

![Untitled](https://user-images.githubusercontent.com/85219306/201024610-a0648d7d-21e1-48e6-af0c-6c500484a52e.png)

> [Lockìœ¼ë¡œ ì´í•´í•˜ëŠ” Transactionì˜ Isolation Level](https://suhwan.dev/2019/06/09/transaction-isolation-level-and-lock/)

> [[ë°ì´í„°ë² ì´ìŠ¤] íŠ¸ëœì­ì…˜ê³¼ ê²©ë¦¬ì„±](https://sabarada.tistory.com/117)

> [MySQL InnoDB lock & deadlock ì´í•´í•˜ê¸°](https://www.letmecompile.com/mysql-innodb-lock-deadlock/)