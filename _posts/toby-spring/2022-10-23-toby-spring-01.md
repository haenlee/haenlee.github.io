---
title:  "[토비의 스프링] 1.3 프로토타입과 스코프"
excerpt: ""

categories:
  - Toby-Spring
tags:
  - [Spring]

toc: true
toc_sticky: true
 
date: 2022-10-23
last_modified_at: 2022-10-23
---

- 기본적으로 스프링의 빈은 싱글톤으로 만들어진다.
    - 사용자의 요청이 있을 때마다 매번 애플리케이션 로직을 담은 오브젝트를 새로 만드는 건 비효율적이기 때문
- 빈을 싱글톤이 아닌 다른 방법으로 만들어 사용할 때가 있다.
    - 하나의 빈 설정으로 여러 개의 오브젝트를 만들어서 사용하는 경우
    - 프로토타입 빈
    - 스코프 빈

<br>
# 1.3.1 프로토타입 스코프
---
- 싱글톤 스코프는 컨텍스트당 한 개의 빈 오브젝트만 만들어지게 한다.
    - 하나의 빈을 여러 개의 빈에서 DI 하더라도 매번 동일한 오브젝트가 주입된다.
- 프로토타입 스코프는 컨테이너에게 빈을 요청할 때마다 매번 새로운 오브젝트를 생성해준다.

## 프로토타입 빈의 생명주기와 종속성
- 프로토타입 빈은 IoC의 기본 원칙을 따르지 않는다.
- 프로토타입 빈 오브젝트는 한번 DL이나 DI를 통해 컨테이너 밖으로 전달된 후에는 이 오브젝트는 더 이상 스프링이 관리하는 빈이 아니다.
- 따라서, 빈 오브젝트의 관리는 전적으로 DI 받은 오브젝트에 종속적이다.
- DL 방식으로 직접 컨테이너에 getBean() 메소드를 통해서 프로토타입 빈을 요청했다면, 요청한 코드가 유지시켜주는 만큼 빈 오브젝트가 존재한다.
    - 메소드 안에서 사용하고 따로 저장해도지 않는다면, 메소드가 끝나면서 프로토타입 빈도 함께 제거됨

## 프로토타입 빈의 용도
- 코드에서 new로 오브젝트를 생성하는 것을 대신하기 위해 사용됨
- 사용자의 요청별로 독립적인 정보나 작업 상태를 저장해둘 오브젝트를 만들 필요가 있을 때

## DI와 DL
- DL: ApplicationContext를 이용해 getBean()을 호출하는 방식
- 코드 내에서 필요할 때마다 컨테이너에게 요청해서 새로운 오브젝트를 만들어야 한다면 DL 방식 사용
- 프로토타입 빈이 DI 방식으로 사용되는 경우는 매우 드물다.

## 프로토타입 빈의 DL 전략
스프링은 프로토타입 빈처럼 DL 방식을 코드에서 사용해야 할 경우 ApplicationContext를 이용하는 것 외에도 다양한 방법을 제공한다.

- ApplicationContext, BeanFactory
    - @Autowired나 @Resource를 이용해 ApplicationContext 또는 BeanFactory를 DI 받은 뒤 getBean()을 직접 호출해서 빈을 가져오는 방법
    - 사용하기는 간단하지만 코드에 스프링 API가 직접 등장한다는 단점이 있다.
- ObjectFactory, ObjectFactoryCreatingFactoryBean
    - 애플리케이션 컨텍스트를 사용하지 않으려면 중간에 getBean()을 호출해주는 역할을 맡을 오브젝트가 필요
    - 팩토리를 이용하는 이유는 오브젝트를 요구하면서 오브젝트를 어떻게 생성하거나 가져오는지에는 신경 쓰지 않을 수 있기 때문에 사용
    - ApplicationContext와 getBean() 처럼 로우레벨의 API를 사용하지 않기 때문에 코드가 깔끔하고, 팩토리 인터페이스를 이용해 만들면 테스트에서 사용하기에도 편리하다.
- ServiceLocatorFactoryBean
    - ObjectFactory처럼 스프링이 미리 정의해둔 인터페이스를 사용하지 않아도 된다.
    - DL 방식으로 가져올 빈을 리턴하는 임의의 이름을 가진 메소드가 정의된 인터페이스가 있으면 된다.
- 메소드 주입
    - ApplicationContext는 스프링 API에 의존적인 코드를 만드는 불편함과 ObjectFactory, ServiceLocatorFactoryBean을 사용하면 코드는 깔끔해지지만 빈을 새로 추가해야하는 번거로움이 있음
    - 두 가지 단점을 극복할 수 있도록 스프링이 제공해주는 DL 전략
    - 메소드를 통한 주입이 아니라 메소드 코드 자체를 주입하는 것을 말한다.
    - 일정한 규칙을 따르는 추상 메소드를 작성해두면 ApplicationContext와 getBean() 메소드를 사용해서 새로운 프로토타입 빈을 가져오는 기능을 담당하는 메소드를 런타임 시에 추가해주는 기술
- Provider<T>
    - @Inject와 함께 JSR-330에 추가된 표준 인터페이스인 Provider를 이용하는 것
    - ObjectFactory와 거의 유사하지만 ObjectFactoryCreatingFactoryBean을 등록해주지 않아도 되기 때문에 사용이 편리하다.
    - Provider 인터페이스를 @Inject, @Autowired, @Resource를 이용해 DI되도록 지정

<br>
# 1.3.2 스코프
---
### 스코프의 종류
스프링은 싱글톤, 프로토타입 외에 요청(request), 세션(session), 글로벌세션(globalSession), 애플리케이션(application)이라는 네가지 스코프를 기본적으로 제공

요청(request), 세션(session), 글로벌세션(globalSession): 싱글톤과 다르게 독립적인 상태를 저장해두고 사용하는데 필요

- 요청 스코프
    - 하나의 웹 요청 안에서 만들어지고 해당 요청이 끝날 때 제거된다.
    - 하나의 요청이 일어나는 메소드 파라미터로 전달되는 도메인 오브젝트나 DTO와 비슷
    - 애플리케이션 코드에서 생성한 정보를 프레임워크 레벨의 서비스나 인터셉터 등에 전달하는 것
- 세션 스코프, 글로벌세션 스코프
    - HTTP 세션과 같은 존재 범위를 갖는 빈으로 만들어주는 스코프
        - 세션 스코프를 이용하면 HTTP 세션에 저장되는 정보를 모든 계층에서 안전하게 이용할 수 있다.
    - 글로벌세션 스코프는 포틀릿에만 존재하는 글로벌 세션에 저장되는 빈
- 애플리케이션 스코프
    - 서블릿 컨텍스트에 저장되는 빈 오브젝트
    - 싱글톤 스코프와 마찬가지로 상태를 갖지 않거나, 상태가 있다고 하더라고 읽기전용으로 만들거나, 멀티스레드 환경에서 안전하도록 만들어야 한다.

### 스코프 빈의 사용 방법
- 프로토타입 빈과 마찬가지로 한 개 이상의 빈 오브젝트가 생성됨 → 싱글톤에 DI 해주는 방법으로 사용할 수 없음
    - 직접 스코프 빈을 DI 하는 대신 스코프 빈에 대한 프록시를 DI 하여 사용
- 하지만 프로토타입 빈과는 다르게 스프링이 생성부터 초기화, DI, DL, 제거까지 전 과정을 관리
- 스코프 빈은 프로토타입 빈과 마찬가지로 Provider나 ObjectFactory 같은 DL 방식을 사용

### 커스텀 스코프와 상태를 저장하는 빈 사용하기
- 스프링이 제공하는 스코프 외에도 임의의 스코프를 만들어 사용할 수 있다. (Scope 인터페이스 구현)
- 스프링 웹 플로우나 제이보스 씸 같은 프레임워크를 이용하면 다양한 커스텀 스코프 제공
- 빈에 상태를 저장해두지 않는다면
    - 상태를 갖지 않는 싱글톤 빈을 사용하고
    - 상태정보는 URL 파라미터, 쿠키, 폼 히든, DB, HTTP 세선에 분산해서 저장해두고 코드로 관리해야 한다.